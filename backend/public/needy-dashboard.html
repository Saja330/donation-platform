<script>
  document.addEventListener('DOMContentLoaded', async function () {
    const userId = localStorage.getItem('userId');
    const username = localStorage.getItem('userName');
    const userEmail = localStorage.getItem('userEmail');
    document.getElementById("username").textContent = `مرحبًا، ${username}`;
    if (!userId) {
      window.location.href = '/login.html';
      return;
    }

    const resReq = await axios.get(`/api/requests-by-user/${userId}`);
    const requests = resReq.data;
    let selectedDonationId = null;

    const reqList = document.getElementById('myRequests');
    reqList.innerHTML = '';
    if (requests.length === 0) {
      reqList.innerHTML = '<li class="list-group-item text-muted">لا توجد طلبات.</li>';
    } else {
      requests.forEach(r => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `
          <strong>${r.donation.item}</strong> - ${new Date(r.timestamp).toLocaleDateString()}<br/>
          الموقع: ${r.donation.city || ''}
          ${r.donorId ? `<br/> معرف المتبرع: <code>${r.donorId}</code>` : ''}
        `;
        reqList.appendChild(li);
      });
    }

    const chatSelect = document.getElementById("chatDonationSelect");
    const chatBox = document.getElementById("chatBox");
    const chatForm = document.getElementById("chatForm");
    const chatMessage = document.getElementById("chatMessage");

    const chatDonations = requests.filter(r => r.donation._id);
    chatDonations.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.donation._id;
      opt.textContent = `${d.donation.item} - ${d.donation.city}`;
      chatSelect.appendChild(opt);
    });

    chatSelect.addEventListener("change", async function () {
      selectedDonationId = this.value;
      if (!selectedDonationId) return;

      const res = await axios.get(`/api/chat/${selectedDonationId}`);
      chatBox.innerHTML = '';
      res.data.forEach(m => {
        const div = document.createElement('div');
        div.className = m.senderId._id === userId ? 'text-end text-primary mb-2' : 'text-start text-dark mb-2';
        div.innerHTML = `<strong>${m.senderId.name}:</strong> ${m.content}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    chatForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!selectedDonationId) return alert("اختر تبرعًا أولاً");

      const selectedRequest = requests.find(r => r.donation._id.toString() === selectedDonationId);
      const inferredReceiver = selectedRequest?.donorId;

      if (!inferredReceiver) return alert("لا يوجد مستلم معرف");

      await axios.post('/api/messages', {
        donationId: selectedDonationId,
        senderId: userId,
        receiverId: inferredReceiver,
        content: chatMessage.value.trim()
      });

      chatMessage.value = '';
      chatSelect.dispatchEvent(new Event('change'));
    });
  });

  document.getElementById("reviewName").value = localStorage.getItem("userName") || '';
  document.getElementById("reviewFormDashboard").addEventListener("submit", async function (e) {
    e.preventDefault();
    const name = localStorage.getItem("userName");
    const rating = document.getElementById("reviewRating").value;
    const comment = document.getElementById("reviewComment").value;
    if (!name || !rating || !comment) return alert("يرجى تعبئة جميع الحقول");
    try {
      await axios.post('/api/reviews', { name, rating, comment });
      alert("✅ تمت إضافة المراجعة");
      document.getElementById("reviewFormDashboard").reset();
    } catch (err) {
      console.error(err);
      alert("❌ فشل في إرسال المراجعة");
    }
  });
</script>
